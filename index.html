<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹å¸³å‹™-é›²ç«¯æœ€çµ‚ç‰ˆ(å«Excel)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD9g8PjN39YeiR302NUbh5t--OZ5FnqS0A",
            authDomain: "ossen-fe1ac.firebaseapp.com",
            projectId: "ossen-fe1ac",
            storageBucket: "ossen-fe1ac.firebasestorage.app",
            messagingSenderId: "504652484858",
            appId: "1:504652484858:web:0c1a847d2e24b67e5f7943",
            measurementId: "G-Q52V0B3940",
            databaseURL: "https://ossen-fe1ac-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.fb = { db, ref, onValue, push, update };
    </script>

    <style>
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: #f1f5f9; }
        .input-dark { background-color: #334155; color: white; border: 1px solid #475569; border-radius: 12px; padding: 12px; outline: none; width: 100%; font-size: 14px; }
        .boss-card { border-left: 8px solid #6366f1 !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        function App() {
            const isBossMode = new URLSearchParams(window.location.search).get('mode') === 'boss';
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
            const [selectedType, setSelectedType] = useState('å…¬å¸ä»¶'); 
            const [projects, setProjects] = useState([]);
            const [formData, setFormData] = useState({ 
                client: '', deposit: 0, balance: 0, 
                orderDate: new Date().toISOString().split('T')[0], 
                staff: 'å…¬å¸', note: '', receipt: 'æœªç¹³', installDate: '', report: ''
            });

            useEffect(() => {
                if (!window.fb) return;
                const pRef = window.fb.ref(window.fb.db, 'projects');
                window.fb.onValue(pRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.keys(data).map(key => ({ ...data[key], firebaseId: key }));
                        setProjects(list.reverse()); 
                    } else { setProjects([]); }
                });
            }, []);

            const filteredProjects = useMemo(() => {
                return projects.filter(p => {
                    const month = new Date(p.orderDate).getMonth() + 1;
                    return month === selectedMonth && p.type === selectedType;
                });
            }, [projects, selectedMonth, selectedType]);

            // ç®—è–ªæ°´å°ˆç”¨ Excel åŒ¯å‡ºåŠŸèƒ½
            const exportExcel = () => {
                if (filteredProjects.length === 0) return alert("ç„¡è³‡æ–™å¯åŒ¯å‡º");
                const data = filteredProjects.map(p => ({
                    "æ—¥æœŸ": p.orderDate,
                    "å®¢æˆ¶åç¨±": p.client,
                    "è² è²¬äºº": p.staff,
                    "ç¸½é‡‘é¡": Number(p.deposit) + Number(p.balance),
                    "è¨‚é‡‘": p.deposit,
                    "å°¾æ¬¾": p.balance,
                    "æ”¶æ“šç‹€æ…‹": p.receipt,
                    "å‚™è¨»": p.note
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "å·¥ç¨‹è–ªæ°´å¸³ç›®");
                XLSX.writeFile(wb, `ossen_è–ªæ°´å ±è¡¨_${selectedMonth}æœˆ_${selectedType}.xlsx`);
            };

            const handleSave = () => {
                if (!formData.client) return alert("è«‹è¼¸å…¥å®¢æˆ¶åç¨±");
                const pRef = window.fb.ref(window.fb.db, 'projects');
                window.fb.push(pRef, { ...formData, type: selectedType });
                setFormData({ ...formData, client: '', deposit: 0, balance: 0, note: '', installDate: '' });
            };

            const updateField = (id, field, value) => {
                const pRef = window.fb.ref(window.fb.db, `projects/${id}`);
                window.fb.update(pRef, { [field]: value });
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="w-16 bg-slate-900 flex flex-col shrink-0 custom-scrollbar overflow-y-auto">
                        { [...Array(12).keys()].map(i => (
                            <button key={i+1} onClick={()=>setSelectedMonth(i+1)} 
                                className={`py-4 text-xs font-bold transition-all ${selectedMonth===i+1?'bg-indigo-600 text-white':'text-slate-500 hover:text-white'}`}>
                                {i+1}æœˆ
                            </button>
                        ))}
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden bg-white">
                        <header className="px-6 py-4 border-b flex justify-between items-center bg-white shadow-sm z-10">
                            <div className="flex items-center gap-4">
                                <h1 className="text-2xl font-black text-slate-800">{selectedMonth}æœˆ <span className="text-indigo-600">{selectedType}</span></h1>
                                {/* ä¿ç•™æ‚¨çš„ Excel åŒ¯å‡ºåŠŸèƒ½ï¼Œä½†è€é—†æ¨¡å¼ä¸‹éš±è— */}
                                {!isBossMode && (
                                    <button onClick={exportExcel} className="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black transition-all">ğŸ“Š åŒ¯å‡º Excel (ç®—è–ªæ°´ç”¨)</button>
                                )}
                            </div>
                            <div className="flex bg-slate-100 p-1 rounded-xl">
                                {['å…¬å¸ä»¶', 'æ¥­å‹™ä»¶', 'åœ°æ¿å£ç´™'].map(t => (
                                    <button key={t} onClick={()=>setSelectedType(t)} 
                                        className={`px-4 py-1.5 rounded-lg text-xs font-black transition-all ${selectedType===t?'bg-white shadow text-indigo-600':'text-slate-400'}`}>
                                        {t}
                                    </button>
                                ))}
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
                            {!isBossMode && (
                                <div className="bg-[#1e293b] p-8 rounded-[32px] shadow-xl space-y-4">
                                    <div className="grid grid-cols-4 gap-3">
                                        <input type="date" className="input-dark" value={formData.orderDate} onChange={e=>setFormData({...formData, orderDate:e.target.value})}/>
                                        <input placeholder="å®¢æˆ¶åç¨±" className="input-dark col-span-2" value={formData.client} onChange={e=>setFormData({...formData, client:e.target.value})}/>
                                        <select className="input-dark" value={formData.staff} onChange={e=>setFormData({...formData, staff:e.target.value})}><option>å…¬å¸</option><option>è© èˆœ</option><option>æŸæ‘</option><option>æ©™å®¶</option></select>
                                    </div>
                                    <div className="grid grid-cols-4 gap-3">
                                        <input type="number" placeholder="è¨‚é‡‘" className="input-dark" value={formData.deposit} onChange={e=>setFormData({...formData, deposit:e.target.value})}/>
                                        <input type="number" placeholder="å°¾æ¬¾" className="input-dark" value={formData.balance} onChange={e=>setFormData({...formData, balance:e.target.value})}/>
                                        <input type="date" className="input-dark" value={formData.installDate} onChange={e=>setFormData({...formData, installDate:e.target.value})}/>
                                        <button onClick={handleSave} className="bg-indigo-500 hover:bg-indigo-400 text-white rounded-xl font-black shadow-lg transition-all text-sm">å„²å­˜æ¡ˆä»¶ (åŒæ­¥è‡³é›²ç«¯)</button>
                                    </div>
                                </div>
                            )}

                            <div className="space-y-4">
                                {filteredProjects.map(p => (
                                    <div key={p.firebaseId} className={`bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4 ${isBossMode ? 'boss-card' : ''}`}>
                                        <div className="w-64">
                                            {/* æ—¥æœŸå­—é«”åŠ å¤§ */}
                                            <p className="text-sm font-bold text-slate-400 font-mono mb-1">{p.orderDate}</p>
                                            <h2 className="text-2xl font-black text-slate-800 leading-tight">{p.client}</h2>
                                            <span className="mt-2 inline-block bg-slate-100 px-3 py-1 rounded-lg text-[10px] font-black text-indigo-500 uppercase">{p.staff}</span>
                                        </div>

                                        <div className="flex-1">
                                            <p className="text-4xl font-black text-slate-900 font-mono">${(Number(p.deposit)+Number(p.balance)).toLocaleString()}</p>
                                            {/* è¨‚é‡‘å°¾æ¬¾å±•ç¤º */}
                                            <p className="text-sm font-bold text-red-500 mt-1">è¨‚é‡‘ {p.deposit} / å°¾æ¬¾ {p.balance}</p>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4 w-full md:w-80">
                                            <div className="bg-orange-50 p-3 rounded-2xl">
                                                <label className="text-[10px] font-black text-orange-400 block mb-1">æ”¶æ“šåŠŸèƒ½</label>
                                                {isBossMode ? (
                                                    <p className="text-xs font-black text-orange-600">{p.receipt}</p>
                                                ) : (
                                                    <select className="w-full bg-transparent text-xs font-black text-orange-600 outline-none" value={p.receipt} onChange={e=>updateField(p.firebaseId, 'receipt', e.target.value)}>
                                                        <option>æœªç¹³</option><option>å·²ç¹³äº¤</option><option>è¨Šæ¯ç¢ºèª</option><option>ç™¼ç¥¨</option><option>å…æ”¶æ“š</option><option>å®‰è£å¾Œè£œ</option>
                                                    </select>
                                                )}
                                            </div>
                                            <div className="bg-indigo-50 p-3 rounded-2xl">
                                                <label className="text-[10px] font-black text-indigo-400 block mb-1">å®‰è£æ—¥æœŸ</label>
                                                {isBossMode ? (
                                                    <p className="text-xs font-black text-indigo-600">{p.installDate || 'å¾…ç¢ºèª'}</p>
                                                ) : (
                                                    <input type="date" className="w-full bg-transparent text-xs font-black text-indigo-600 outline-none" value={p.installDate} onChange={e=>updateField(p.firebaseId, 'installDate', e.target.value)} />
                                                )}
                                            </div>
                                        </div>

                                        {!isBossMode && (
                                            <div className="w-full md:w-64">
                                                <textarea className="w-full h-16 bg-slate-50 rounded-2xl p-3 text-[11px] font-bold text-slate-500 outline-none border-none resize-none" placeholder="å‚™è¨»..." value={p.note} onChange={e=>updateField(p.firebaseId, 'note', e.target.value)} />
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

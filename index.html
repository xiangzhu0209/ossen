<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹å¸³å‹™-é›²ç«¯å…¨åŠŸèƒ½åˆé«”ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD9g8PjN39YeiR302NUbh5t--OZ5FnqS0A",
            authDomain: "ossen-fe1ac.firebaseapp.com",
            projectId: "ossen-fe1ac",
            storageBucket: "ossen-fe1ac.firebasestorage.app",
            messagingSenderId: "504652484858",
            appId: "1:504652484858:web:0c1a847d2e24b67e5f7943",
            measurementId: "G-Q52V0B3940",
            databaseURL: "https://ossen-fe1ac-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.fb = { db, ref, onValue, push, update };
    </script>

    <style>
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: #f8fafc; }
        .input-dark { background-color: #334155; color: white; border: 1px solid #475569; border-radius: 12px; padding: 12px; outline: none; font-size: 14px; }
        .label-tiny { font-size: 10px; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .custom-card { border-radius: 32px; transition: all 0.3s ease; }
        /* å”¯è®€æ¨¡å¼ä¸‹è®“ä¸‹æ‹‰é¸å–®çœ‹èµ·ä¾†ä¸åƒå¯ä»¥æŒ‰ */
        select:disabled, input:disabled, textarea:disabled { cursor: not-allowed; opacity: 0.8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        function App() {
            const isBossMode = new URLSearchParams(window.location.search).get('mode') === 'boss';
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
            const [selectedType, setSelectedType] = useState('å…¬å¸ä»¶'); 
            const [projects, setProjects] = useState([]);
            
            const [formData, setFormData] = useState({ 
                client: '', deposit: 0, balance: 0, 
                orderDate: new Date().toISOString().split('T')[0], 
                staff: 'å…¬å¸', note: '', receipt: 'æœªç¹³', installDate: '', report: ''
            });

            const getProjectStatus = (p) => {
                if (p.report === 'æœ‰ç‹€æ³') return "âš ï¸ æœ‰ç‹€æ³";
                if (!p.installDate) return "å¾…ç¢ºèª";
                const today = new Date(); today.setHours(0,0,0,0);
                const install = new Date(p.installDate); install.setHours(0,0,0,0);
                return today >= install ? "å®Œå·¥" : "æ­£å¸¸";
            };

            useEffect(() => {
                if (!window.fb) return;
                const pRef = window.fb.ref(window.fb.db, 'projects');
                window.fb.onValue(pRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.keys(data).map(key => ({ ...data[key], firebaseId: key }));
                        setProjects(list.reverse()); 
                    } else { setProjects([]); }
                });
            }, []);

            const filteredProjects = useMemo(() => {
                return projects.filter(p => {
                    const month = new Date(p.orderDate).getMonth() + 1;
                    return month === selectedMonth && p.type === selectedType;
                });
            }, [projects, selectedMonth, selectedType]);

            const exportToExcel = () => {
                const data = filteredProjects.map(p => ({
                    "æ—¥æœŸ": p.orderDate, "å®¢æˆ¶åç¨±": p.client, "ç¸½é‡‘é¡": Number(p.deposit)+Number(p.balance), "å·¥ç¨‹ç‹€æ…‹": getProjectStatus(p), "å‚™è¨»": p.note
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "å ±è¡¨");
                XLSX.writeFile(wb, `${selectedMonth}æœˆ_${selectedType}.xlsx`);
            };

            const handleSave = () => {
                if (isBossMode) return; // å®‰å…¨æ©Ÿåˆ¶
                if (!formData.client) return alert("è«‹è¼¸å…¥å®¢æˆ¶");
                const pRef = window.fb.ref(window.fb.db, 'projects');
                const dStatus = Number(formData.deposit) === 0 ? 'ç„¡è¨‚é‡‘' : 'æœªç¹³';
                const bStatus = Number(formData.balance) === 0 ? 'ç„¡å°¾æ¬¾' : 'æœªç¹³';
                window.fb.push(pRef, { ...formData, dStatus, bStatus, type: selectedType });
                setFormData({ ...formData, client: '', deposit: 0, balance: 0, note: '', installDate: '', report: '' });
            };

            const updateField = (id, field, value) => {
                if (isBossMode) return; // å¾¹åº•é˜²æ­¢è€é—†æ”¹å‹•
                const pRef = window.fb.ref(window.fb.db, `projects/${id}`);
                window.fb.update(pRef, { [field]: value });
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="w-24 bg-[#0f172a] flex flex-col shrink-0">
                        <div className="p-4 text-white font-black text-center border-b border-slate-800">2026</div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1">
                            { [...Array(12).keys()].map(i => (
                                <button key={i+1} onClick={()=>setSelectedMonth(i+1)} className={`w-full py-3 rounded-lg font-bold text-xs ${selectedMonth===i+1?'bg-indigo-600 text-white shadow-lg':'text-slate-500'}`}>{i+1}æœˆ</button>
                            ))}
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col bg-white overflow-hidden">
                        <header className="px-10 py-6 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <h1 className="text-3xl font-black text-slate-800">
                                    {selectedMonth}æœˆ <span className="text-indigo-600">{selectedType}</span>
                                    {isBossMode && <span className="ml-4 text-xs bg-slate-200 text-slate-500 px-2 py-1 rounded">å”¯è®€æ¨¡å¼</span>}
                                </h1>
                                {!isBossMode && <button onClick={exportToExcel} className="bg-emerald-500 text-white px-4 py-1.5 rounded-xl text-xs font-black shadow-lg">ğŸ“Š åŒ¯å‡º Excel</button>}
                            </div>
                            <div className="flex bg-slate-100 p-1 rounded-xl">
                                {['å…¬å¸ä»¶', 'æ¥­å‹™ä»¶', 'åœ°æ¿å£ç´™'].map(t => (
                                    <button key={t} onClick={()=>setSelectedType(t)} className={`px-6 py-2 rounded-lg font-black text-xs ${selectedType===t?'bg-white text-indigo-600 shadow-sm':'text-slate-400'}`}>{t}</button>
                                ))}
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto px-10 py-6 space-y-8 bg-slate-50">
                            {!isBossMode && (
                                <div className="bg-[#1e293b] p-8 rounded-[40px] shadow-2xl">
                                    <div className="grid grid-cols-6 gap-4">
                                        <div className="col-span-1"><label className="label-tiny">ORDER DATE</label><input type="date" className="input-dark w-full" value={formData.orderDate} onChange={e=>setFormData({...formData, orderDate:e.target.value})}/></div>
                                        <div className="col-span-3"><label className="label-tiny">CLIENT NAME</label><input placeholder="è«‹è¼¸å…¥å®¢æˆ¶åç¨±..." className="input-dark w-full" value={formData.client} onChange={e=>setFormData({...formData, client:e.target.value})}/></div>
                                        <div className="col-span-2"><label className="label-tiny">STAFF</label><select className="input-dark w-full appearance-none" value={formData.staff} onChange={e=>setFormData({...formData, staff:e.target.value})}><option>å…¬å¸</option><option>è© èˆœ</option><option>æŸæ‘</option><option>æ©™å®¶</option></select></div>
                                        <div className="col-span-1"><label className="label-tiny">DEPOSIT</label><input type="number" className="input-dark w-full font-mono" value={formData.deposit} onChange={e=>setFormData({...formData, deposit:e.target.value})}/></div>
                                        <div className="col-span-1"><label className="label-tiny">BALANCE</label><input type="number" className="input-dark w-full font-mono" value={formData.balance} onChange={e=>setFormData({...formData, balance:e.target.value})}/></div>
                                        <div className="col-span-1"><label className="label-tiny">INSTALL DATE</label><input type="date" className="input-dark w-full" value={formData.installDate} onChange={e=>setFormData({...formData, installDate:e.target.value})}/></div>
                                        <div className="col-span-2"><label className="label-tiny">REMARK</label><input placeholder="å‚™è¨»å…§å®¹..." className="input-dark w-full" value={formData.note} onChange={e=>setFormData({...formData, note:e.target.value})}/></div>
                                        <div className="col-span-1 flex items-end"><button onClick={handleSave} className="w-full bg-indigo-500 py-3 rounded-xl font-black text-xs text-white shadow-lg">ç¢ºèªå„²å­˜</button></div>
                                    </div>
                                </div>
                            )}

                            <div className="space-y-4">
                                {filteredProjects.map(p => {
                                    const status = getProjectStatus(p);
                                    const showBalanceWarning = status === "å®Œå·¥" && p.bStatus === 'æœªç¹³';
                                    return (
                                        <div key={p.firebaseId} className="bg-white rounded-[32px] p-8 border border-slate-100 shadow-sm flex items-center">
                                            <div className="w-64">
                                                <p className="text-sm font-bold text-slate-400 font-mono mb-1">{p.orderDate}</p>
                                                <h3 className="text-2xl font-black text-slate-800 leading-tight">{p.client}</h3>
                                                <span className="mt-2 inline-block bg-slate-100 px-3 py-1 rounded-lg text-[10px] font-black text-indigo-500 uppercase">{p.staff}</span>
                                            </div>

                                            <div className="flex-1 px-8">
                                                <p className="text-4xl font-black text-slate-800 font-mono">${(Number(p.deposit)+Number(p.balance)).toLocaleString()}</p>
                                                <p className="text-sm font-bold text-red-500 mt-1 uppercase font-black">è¨‚é‡‘ {p.deposit} / å°¾æ¬¾ {p.balance}</p>
                                            </div>

                                            <div className="flex-[1.8] grid grid-cols-2 gap-x-8 gap-y-4 px-8 border-x border-slate-50">
                                                <div>
                                                    <label className="text-[10px] font-black text-indigo-400 block mb-1">è¨‚é‡‘ç‹€æ…‹</label>
                                                    <select disabled={isBossMode} className={`w-full text-xs font-bold rounded-xl px-4 py-2 border ${p.dStatus === 'æœªç¹³' ? 'bg-red-50 text-red-500 border-red-100' : 'bg-slate-50 border-transparent text-slate-500'}`} value={p.dStatus} onChange={e=>updateField(p.firebaseId, 'dStatus', e.target.value)}>
                                                        <option>æœªç¹³</option><option>å·²è½‰å¸³</option><option>å·²ä»˜ç¾</option><option>ç„¡è¨‚é‡‘</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-black text-emerald-400 block mb-1">å·¥ç¨‹ç‹€æ…‹</label>
                                                    <div className={`text-center py-2 rounded-xl text-xs font-black text-white ${status === 'å®Œå·¥' ? 'bg-emerald-500' : status.includes('æœ‰ç‹€æ³') ? 'bg-amber-500' : 'bg-blue-500'}`}>
                                                        {status}
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-black text-indigo-400 block mb-1">å°¾æ¬¾ç‹€æ…‹</label>
                                                    <select disabled={isBossMode} className={`w-full text-xs font-bold rounded-xl px-4 py-2 border ${showBalanceWarning ? 'bg-red-50 text-red-500 border-red-100' : 'bg-slate-50 border-transparent text-slate-500'}`} value={p.bStatus} onChange={e=>updateField(p.firebaseId, 'bStatus', e.target.value)}>
                                                        <option>æœªç¹³</option><option>å·²è½‰å¸³</option><option>å·²ä»˜ç¾</option><option>æ”¯ç¥¨</option><option>è«‹æ¬¾ä¸­</option><option>ç„¡å°¾æ¬¾</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-black text-orange-400 block mb-1">æ”¶æ“šåŠŸèƒ½</label>
                                                    <select disabled={isBossMode} className="w-full text-xs font-bold rounded-xl px-4 py-2 bg-orange-50 text-orange-600 border border-orange-100" value={p.receipt} onChange={e=>updateField(p.firebaseId, 'receipt', e.target.value)}>
                                                        <option>æœªç¹³</option><option>å·²ç¹³äº¤</option><option>è¨Šæ¯ç¢ºèª</option><option>ç™¼ç¥¨</option><option>å…æ”¶æ“š</option><option>å®‰è£å¾Œè£œ</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="w-56 px-8 flex flex-col gap-2">
                                                <label className="text-[10px] font-black text-indigo-400 block">å®‰è£æ—¥æœŸ</label>
                                                <input disabled={isBossMode} type="date" className="w-full bg-slate-50 rounded-xl px-3 py-2 text-xs font-bold" value={p.installDate} onChange={e=>updateField(p.firebaseId, 'installDate', e.target.value)} />
                                                {!isBossMode && (
                                                    <button onClick={()=>updateField(p.firebaseId, 'report', p.report==='æœ‰ç‹€æ³'?'':'æœ‰ç‹€æ³')} className={`text-[9px] font-black py-1 rounded-md border ${p.report === 'æœ‰ç‹€æ³' ? 'bg-amber-500 text-white' : 'text-slate-300 border-slate-200'}`}>
                                                        {p.report === 'æœ‰ç‹€æ³' ? 'è§£é™¤ç‹€æ³' : 'æ¨™è¨˜ç‹€æ³'}
                                                    </button>
                                                )}
                                            </div>

                                            <div className="flex-1">
                                                <textarea disabled={isBossMode} className="w-full h-20 bg-slate-50 rounded-2xl p-4 text-[11px] font-bold text-slate-500 outline-none border-none resize-none" placeholder="å‚™è¨»å…§å®¹..." value={p.note} onChange={e=>updateField(p.firebaseId, 'note', e.target.value)} />
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
